general:
  branches:
    only:
      - packaging_circleci

machine:
  services:
    - docker

## Customize dependencies
dependencies:
  pre:
    - gem install --no-ri --no-rdoc package_cloud
    - sudo pip install --upgrade bumpversion
    - git config --global user.email "klou+circle@heroku.com"
    - git config --global user.name "Circle CI"

  post:
    - bumpversion --tag --commit --current-version $(cat VERSION) patch VERSION
    - docker run -v $(pwd):/p -i -t klou/dod-precise-builder make -f /p/package/Makefile package
    # - docker run -v $(pwd):/p -i -t klou/dod-trusty-builder make -f /p/package/Makefile package

deployment:
  production:
    branch: packaging_circleci
    commands:
      - package_cloud push klou/ex/ubuntu/precise $(pwd)/package/ubuntu/precise/*.deb
      - git push origin v$(cat VERSION)
      - git push origin $CIRCLE_BRANCH
      # - package_cloud push klou/ex/ubuntu/trusty $(pwd)/package/ubuntu/trusty/*.deb
